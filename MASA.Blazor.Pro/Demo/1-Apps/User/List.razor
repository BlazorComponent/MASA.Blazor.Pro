@page "/apps/user/list"
@namespace MASA.Blazor.Pro.Demo.Apps.User
@using MASA.Blazor.Pro.Data.User
@inherits DemoCompontentBase
@inject NavigationManager Nav

<MCard Elevation=2>
    <MCardText>
        <h3 class="black--text">Filters</h3>
        <MRow Class="mt-2">
            <MCol Sm=12 Md=4>
                <MSelect @bind-Value="_userPage.Role"
                         Color="deep-purple"
                         Clearable
                         Outlined
                         Dense
                         Items="@UserService.Roles"
                         ItemText="u => u"
                         ItemValue="u => u"
                         Label="Role">
                </MSelect>
            </MCol>
            <MCol Sm=12 Md=4>
                <MSelect @bind-Value="_userPage.Plan"
                         Color="deep-purple"
                         Clearable
                         Outlined
                         Dense
                         Items="@UserService.Plans"
                         ItemText="u => u"
                         ItemValue="u => u"
                         Label="Plan">
                </MSelect>
            </MCol>
            <MCol Sm=12 Md=4>
                <MSelect @bind-Value="_userPage.Status"
                         Color="deep-purple"
                         Clearable
                         Outlined
                         Dense
                         Items="@UserService.Status"
                         ItemText="u => u"
                         ItemValue="u => u"
                         Label="Status">
                </MSelect>
            </MCol>
        </MRow>
    </MCardText>
</MCard>

<MCard Elevation=2 Class="mt-7">
    <MCardText>
        <div class="d-flex">
            <div class="mr-auto d-flex">
                <div class="pt-2">Show</div>
                <MSelect @bind-Value="_userPage.PageSize"
                         Color="deep-purple"
                         Style="width:90px"
                         Class="mx-2"
                         Outlined
                         Dense                         
                         Items="@_pageSizes"
                         ItemText="u => u.ToString()"
                         ItemValue="u => u">
                </MSelect>
                <span class="pt-2">entries</span>
            </div>
            <div class="d-flex">
                <MTextField @bind-Value="_userPage.Search"
                            TValue="string"
                            HideDetails="true"
                            Color="deep-purple"
                            Outlined Dense
                            Style="width:600px"
                            Placeholder="Search">
                </MTextField>
                <MButton Color="deep-purple" Class="white--text ml-3" OnClick="()=>_visible=true">
                    Add User
                </MButton>
            </div>
        </div>
    </MCardText>

    <MDataTable Headers="_headers" Items="_userPage.GetPageDatas()" ItemsPerPage="_userPage.PageSize" Page="_userPage.PageIndex" HideDefaultFooter Class="border-top-solid mt-n4">
        <ItemColContent>
            @switch (context.Header.Value)
            {
                case nameof(UserData.UserName):
                    <MListItem class="d-flex my-2" OnClick="()=>NavigateToDetails(context.Item.Id)">
                        @if (string.IsNullOrEmpty(context.Item.HeadImg))
                        {
                            string color = context.Item.Color;

                            <MAvatar Size=35 Color="@($"{color} lighten-5")" Class="mt-1">
                                <span class="@($"{color}--text")">@context.Item.SampleName</span>
                            </MAvatar>
                        }
                        else
                        {
                            <MAvatar Size=35 Class="mt-1">
                                <MImage Contain Src="@context.Item.HeadImg"></MImage>
                            </MAvatar>
                        }
                        <div class="ml-4">
                            <div class="deep-purple--text">@context.Item.FullName</div>
                            <div class="grey--text text-caption">@@@context.Item.UserName</div>
                        </div>
                    </MListItem>
                    break;
                case (nameof(UserData.Email)):
                    <span>@context.Item.Email</span>
                    break;
                case nameof(UserData.Role):
                    var arr = _roleIconMap[context.Item.Role!].Split(",");
                    <MIcon Left Small Class="@($"{arr[1]}--text")">@arr[0]</MIcon>
                    @context.Item.Role
                    break;
                case (nameof(UserData.Plan)):
                    @context.Item.Plan
                    break;
                case nameof(UserData.Status):
                    string statusColor = context.Item.Color;
                    <MChip Color="@($"{statusColor} lighten-5")">
                       <span class="@($"{statusColor}--text")">@context.Item.Status</span>
                    </MChip>
                    break;
                case "Action":
                    <MMenu Right Bottom>
                        <ActivatorContent Context="activatorContext">
                            <MButton Icon @attributes="@activatorContext.Attrs">
                                <MIcon XSmall>fas fa-ellipsis-v</MIcon>
                            </MButton>
                        </ActivatorContent>
                        <ChildContent>
                            <MList>
                                <MListItem OnClick="()=>NavigateToDetails(context.Item.Id)">
                                    <MIcon Small>fas fa-user-tie</MIcon>
                                    <MListItemTitle Class="ml-2"> Details </MListItemTitle>
                                </MListItem>
                                <MListItem OnClick="()=>NavigateToEdit(context.Item.Id)">
                                    <MIcon Small>far fa-edit</MIcon>
                                    <MListItemTitle Class="ml-2"> Edit </MListItemTitle>
                                </MListItem>
                                <MListItem OnClick="()=>_userPage.UserDatas.RemoveAt(_userPage.UserDatas.FindIndex(u=>u.Id==context.Item.Id))">
                                    <MIcon Small>far fa-trash-alt</MIcon>
                                    <MListItemTitle Class="ml-2"> Delete </MListItemTitle>
                                </MListItem>
                            </MList>
                        </ChildContent>
                    </MMenu>
                    break;
                default:
                    @context.Value
                    break;
            }
        </ItemColContent>
    </MDataTable>

    <MCardText>
        <div class="d-flex">
            <div class="mr-auto pt-3">Showing @((_userPage.PageIndex-1)*_userPage.PageSize+1) to @(_userPage.PageIndex*_userPage.PageSize) of @_userPage.CurrentCount entries</div>        
            <MPagination @bind-Value="_userPage.PageIndex" Color="deep-purple" Circle Length=@_userPage.PageCount></MPagination>
        </div>
    </MCardText>
</MCard>

<Add Visible=_visible ValueChanged="val=>_visible = val" Submit="AddUserData"></Add>

@code {
    public override string Name { get; } = "User-List";

    public bool _visible;

    public UserPage _userPage = new UserPage(UserService.UserDatas);

    List<int> _pageSizes = new List<int>
    {
        10,25,50,100
    };

    List<DataTableHeader<UserData>> _headers = new List<DataTableHeader<UserData>>
    {
        new (){ Text= "USER", Value= nameof(UserData.UserName)},
        new (){ Text= "EMAIL", Value= nameof(UserData.Email)},
        new (){ Text= "ROLE", Value= nameof(UserData.Role)},
        new (){ Text= "PLAN", Value= nameof(UserData.Plan)},
        new (){ Text= "STATUS", Value= nameof(UserData.Status)},
        new (){ Text= "ACTIONS", Value= "Action"}
    };

    Dictionary<string, string> _roleIconMap = new Dictionary<string, string>
    {
        ["Editor"]="mdi-pencil,cyan",
        ["Subscriber"]="far fa-user,deep-purple",
        ["Admin"]="fas fa-user-cog,red",
        ["Maintainer"]="fas fa-database,green",
        ["Author"]="fas fa-cog,orange",
    };

    void NavigateToDetails(string id)
    {
        Nav.NavigateTo($"/apps/user/view/{id}");
    }

    void NavigateToEdit(string id)
    {
        Nav.NavigateTo($"/apps/user/edit/{id}");
    }

    void AddUserData(UserData userData)
    {
        _userPage.UserDatas.Insert(0,userData);
        base.InvokeAsync(base.StateHasChanged);
    }
}